<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Assessment Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --accent: #a855f7;
            --glass: rgba(255, 255, 255, 0.85);
            --text-dark: #0f172a;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }

        body {
            height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center;
            overflow: hidden; background-color: #030712;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
        }

        .bg-orb { position: absolute; width: 600px; height: 600px; border-radius: 50%; filter: blur(80px); z-index: 0; opacity: 0.35; animation: move 20s infinite alternate; }
        .orb-1 { background: var(--primary); top: -10%; left: -10%; }
        .orb-2 { background: var(--accent); bottom: -10%; right: -10%; animation-delay: -10s; }
        @keyframes move { from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(100px, 100px) rotate(30deg); } }

        .top-nav { position: absolute; top: 30px; right: 30px; z-index: 100; }
        .btn-logout { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 10px 20px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(10px); font-weight: 600; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .btn-logout:hover { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; }

        .assessment-card { position: relative; z-index: 10; width: 90%; max-width: 500px; background: var(--glass); backdrop-filter: blur(30px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 32px; box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.5); overflow: hidden; }

        .header { padding: 32px 32px 10px; }
        .q-badge { background: rgba(99, 102, 241, 0.1); color: var(--primary); padding: 6px 14px; border-radius: 100px; font-size: 11px; font-weight: 800; letter-spacing: 1px; border: 1px solid rgba(99, 102, 241, 0.2); }
        .progress-track { height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; margin-top: 15px; overflow: hidden; }
        #fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: 0.8s ease; }

        .content { padding: 24px 32px 32px; min-height: 350px; display: flex; flex-direction: column; justify-content: center; }
        .question-text { font-size: 22px; font-weight: 800; color: var(--text-dark); margin-bottom: 25px; line-height: 1.3; }

        .option-item { background: white; padding: 16px 20px; border-radius: 18px; border: 2px solid transparent; cursor: pointer; transition: 0.2s; font-weight: 600; color: #475569; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); display: flex; align-items: center; justify-content: space-between; }
        .option-item:hover { transform: translateX(5px); border-color: #e2e8f0; }
        .option-item.selected { border-color: var(--primary); background: #f5f3ff; color: var(--primary); box-shadow: 0 10px 20px -5px var(--primary-glow); }

        .status-container { text-align: center; }
        .status-icon-wrap { width: 80px; height: 80px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: var(--primary); font-size: 32px; }
        
        .footer { padding: 20px 32px 32px; display: none; justify-content: flex-end; background: rgba(255, 255, 255, 0.3); }
        .btn-continue { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; padding: 14px 40px; border-radius: 15px; border: none; font-weight: 800; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 25px -5px var(--primary-glow); }
        .btn-continue:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="top-nav">
        <button class="btn-logout" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i> LOGOUT
        </button>
    </div>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="assessment-card">
        <div class="header">
            <span class="q-badge" id="step-title">PREPARING...</span>
            <div class="progress-track"><div id="fill"></div></div>
        </div>

        <div class="content" id="main-view">
            <div style="text-align: center; color: #64748b; padding: 40px;">
                <i class="fas fa-circle-notch fa-spin" style="font-size: 32px; margin-bottom: 15px; color: var(--primary);"></i>
                <p>Loading Questions...</p>
            </div>
        </div>

        <div class="footer" id="ctrls">
            <button class="btn-continue" id="nxt" onclick="goNext()" disabled>CONTINUE</button>
        </div>
    </div>

<script>
    const QUESTIONS_API = "http://localhost:8080/public/questions";
    const SUBMIT_API = "http://localhost:8080/public/submit";
    
    let state = { 
        questions: [], 
        currentIdx: 0, 
        selections: {},
        assessmentId: "" 
    };

    async function initialize() {
        const mainView = document.getElementById('main-view');
        try {
            const res = await fetch(QUESTIONS_API);
            if (!res.ok) throw new Error("API Connection Failed");
            
            const responseData = await res.json();
            // FIX: Accessing the 'data' array from your response
            state.questions = responseData.data || []; 

            if (state.questions && state.questions.length > 0) {
                // Get assessmentId from the first question
                state.assessmentId = state.questions[0].assessmentId || "DEFAULT_ID";
                
                document.getElementById('ctrls').style.display = 'flex';
                render();
            } else {
                mainView.innerHTML = `<div style="text-align:center; padding:40px;"><p>No questions found in the bank.</p></div>`;
            }
        } catch (e) {
            console.error(e);
            mainView.innerHTML = `<div style="text-align:center; padding:40px; color:red;"><p>Unable to connect to server. Please check if backend is running.</p></div>`;
        }
    }

	function render() {
	    const q = state.questions[state.currentIdx];
	    const container = document.getElementById('main-view');
	    const nxtBtn = document.getElementById('nxt');
	    
	    document.getElementById('step-title').innerText = `STEP ${state.currentIdx + 1} OF ${state.questions.length}`;
	    document.getElementById('fill').style.width = `${((state.currentIdx + 1) / state.questions.length) * 100}%`;

	    let html = `<div class="question-text">${q.questionText}</div>`;
	    
	    if (q.questionType === 'TEXT') {
	        // TEXT Type ke liye Input Box
	        const savedVal = state.selections[state.currentIdx] || "";
	        html += `
	            <div class="form-group" style="margin-top:20px;">
	                <input type="text" id="userTextAnswer" 
	                    placeholder="Type your answer here..." 
	                    class="option-item" 
	                    style="width:100%; cursor:text; outline:none; border:2px solid #e2e8f0;"
	                    oninput="handleTextInput(this.value)"
	                    value="${savedVal}">
	            </div>`;
	    } else {
	       
	        html += `<div class="options-grid">`;
	        q.options.forEach(opt => {
	            const isSelected = state.selections[state.currentIdx] === opt.id;
	            html += `
	                <div class="option-item ${isSelected ? 'selected' : ''}" onclick="handlePick(${opt.id})">
	                    ${opt.optionText}
	                    ${isSelected ? '<i class="fas fa-check-circle"></i>' : ''}
	                </div>`;
	        });
	        html += `</div>`;
	    }
	    
	    container.innerHTML = html;
	    
	    // Button enable logic
	    nxtBtn.disabled = !state.selections[state.currentIdx];
	}

    function handlePick(id) { 
        state.selections[state.currentIdx] = id; 
        render(); 
    }

    function goNext() {
        if (state.currentIdx < state.questions.length - 1) {
            state.currentIdx++;
            render();
        } else {
            showFinalResult();
        }
    }

	function showFinalResult() {
	        let correctCount = 0;
	        state.questions.forEach((q, i) => {
	            const userSelection = state.selections[i];
	            
	            if (q.questionType === 'TEXT') {
	              
	                if (userSelection && userSelection.toString().trim().length > 0) {
	                    correctCount++;
	                }
	            } else {
	                
	                const correctOpt = q.options.find(o => o.correct === true);
	                if (correctOpt && userSelection === correctOpt.id) {
	                    correctCount++;
	                }
	            }
	        });

	        const percent = (correctCount / state.questions.length) * 100;
	        const status = percent >= 80 ? "PASS" : "FAIL";
	        
	        document.getElementById('ctrls').style.display = 'none';
	        document.getElementById('step-title').innerText = "ASSESSMENT COMPLETE";

	        let resultHTML = `
	            <div class="status-container">
	                <div class="status-icon-wrap" style="color:${percent >= 80 ? '#10b981' : '#ef4444'}">
	                    <i class="fas ${percent >= 80 ? 'fa-award' : 'fa-exclamation-circle'}"></i>
	                </div>
	                <h1 style="font-size:48px; font-weight:800;">${percent.toFixed(0)}%</h1>
	                <p style="margin-bottom:20px; color:#64748b;">You answered ${correctCount} out of ${state.questions.length} correctly.</p>
	                <button class="btn-continue" style="width:100%" onclick="submitAssessment(${percent}, '${status}')">Submit Assessment</button>
	            </div>`;

	        document.getElementById('main-view').innerHTML = resultHTML;
	        if(percent >= 80) confetti({ particleCount: 150, spread: 70 });
	    }
	function handleTextInput(val) {
	    state.selections[state.currentIdx] = val.trim();
	    document.getElementById('nxt').disabled = val.trim().length === 0;
	}
    async function submitAssessment(score, status) {
        const username = localStorage.getItem('username') || "Guest";
        const body = { userId: username, score: score, assessmentId: state.assessmentId, status: status };

        try {
            const res = await fetch(SUBMIT_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (res.ok) {
                document.getElementById('main-view').innerHTML = `
                    <div class="status-container">
                        <i class="fas fa-check-circle" style="font-size:48px; color:var(--success)"></i>
                        <h2 style="margin-top:20px;">Submitted Successfully!</h2>
                        <p>Your performance has been recorded.</p>
                        <button class="btn-continue" style="margin-top:20px;" onclick="handleLogout()">EXIT PORTAL</button>
                    </div>`;
            }
        } catch (e) { alert("Submission failed!"); }
    }

    function handleLogout() { localStorage.clear(); window.location.href = "login.html"; }

    // Start
    initialize();
</script>
</body>
</html>